<?php
/**
 * @var \NeutromeLabs\Mcp\Block\Adminhtml\AiChatButton $block
 * @var \Magento\Framework\Escaper $escaper
 */
?>
<?php if ($block->shouldDisplayButton()): ?>
    <?php $aiChatUrl = $escaper->escapeUrl($block->getAiChatUrl()); ?>
    <button id="ai-chat-popup-button"
            class="ai-chat-button"
            title="<?= $escaper->escapeHtmlAttr(__('Open AI Chat')) ?>"
            type="button">
        <span><?= $escaper->escapeHtml(__('AI')) ?></span>
    </button>

    <div id="ai-chat-modal-popup" class="ai-chat-modal" style="display: none;">
        <div class="ai-chat-modal-content">
            <button class="ai-chat-modal-close" title="<?= $escaper->escapeHtmlAttr(__('Close')) ?>">&times;</button>
            <iframe id="ai-chat-iframe" src="" width="100%" height="100%" frameborder="0"></iframe>
        </div>
    </div>

    <script type="text/javascript">
        require(['jquery'], function($) {
            'use strict';

            var modal = $('#ai-chat-modal-popup');
            var iframe = $('#ai-chat-iframe');
            var openButton = $('#ai-chat-popup-button');
            var closeButton = modal.find('.ai-chat-modal-close');
            var chatUrl = '<?= /* @noEscape */ $aiChatUrl ?>';

            openButton.on('click', function() {
                if (chatUrl) {
                    // Set iframe src only if it's not already set or different (optional optimization)
                    if (iframe.attr('src') !== chatUrl) {
                         iframe.attr('src', chatUrl);
                    }
                    modal.show();
                } else {
                    console.error('AI Chat URL is not configured.');
                    // Optionally show an alert to the user
                    // alert('<?= $escaper->escapeJs(__('AI Chat URL is not configured.')) ?>');
                }
            });

            closeButton.on('click', function() {
                modal.hide();
                // Optional: Clear iframe src when closing to stop potential background activity
                // iframe.attr('src', '');
            });

            // Optional: Close modal if clicking outside the content area
            modal.on('click', function(event) {
                if ($(event.target).is(modal)) {
                    modal.hide();
                    // iframe.attr('src', '');
                }
            });
        });
    </script>
<?php endif; ?>
